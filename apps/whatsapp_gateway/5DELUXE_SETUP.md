# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ WhatsApp-–±–æ—Ç–∞ –¥–ª—è 5deluxe

## üìã –û–±–∑–æ—Ä

WhatsApp-–±–æ—Ç –¥–ª—è **5deluxe** —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ä–µ–∂–∏–º–µ **–ø—Ä–æ—Å—Ç–æ–≥–æ IVR-–º–µ–Ω—é** (–±–µ–∑ OpenAI) –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ü–∏—Ñ—Ä–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã –≤–º–µ—Å—Ç–æ –∫–Ω–æ–ø–æ–∫.

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –†–æ—É—Ç–∏–Ω–≥ –ø–æ tenant:
- **evopoliki** ‚Üí –£–º–Ω—ã–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å OpenAI (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π)
- **5deluxe** ‚Üí –ü—Ä–æ—Å—Ç–æ–µ IVR-–º–µ–Ω—é (–Ω–æ–≤—ã–π)

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–π–ª—ã:
1. **`main.py`** - –≥–ª–∞–≤–Ω—ã–π —Ä–æ—É—Ç–µ—Ä, —Ä–∞–∑–ª–∏—á–∞–µ—Ç tenant –ø–æ `idInstance`
2. **`ivr_handlers_5deluxe.py`** - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ IVR-—Å—Ü–µ–Ω–∞—Ä–∏—è –¥–ª—è 5deluxe
3. **`packages/core/keyboards/whatsapp_ui.py`** - –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –º–µ–Ω—é
4. **`state_manager.py`** - FSM –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

---

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### –®–∞–≥ 1: –î–æ–±–∞–≤—å—Ç–µ WhatsApp-–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ `.env`

–û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª `apps/five_deluxe/.env` –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –ø–æ–ª—è:

```env
# WhatsApp Configuration (GreenAPI)
FIVE_DELUXE_WHATSAPP_INSTANCE_ID=your_instance_id_here    # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à idInstance
FIVE_DELUXE_WHATSAPP_API_TOKEN=your_api_token_here        # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à apiTokenInstance
FIVE_DELUXE_WHATSAPP_API_URL=https://your_instance.api.greenapi.com  # URL –≤–∞—à–µ–≥–æ –∏–Ω—Å—Ç–∞–Ω—Å–∞
FIVE_DELUXE_WHATSAPP_PHONE_NUMBER=+996XXXXXXXXX           # –í–∞—à WhatsApp –Ω–æ–º–µ—Ä
```

**–í–ê–ñ–ù–û:** –ü—Ä–µ—Ñ–∏–∫—Å `FIVE_DELUXE_` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞–ø–∏—Å–∞–Ω **–ó–ê–ì–õ–ê–í–ù–´–ú–ò –ë–£–ö–í–ê–ú–ò**.

### –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ Webhook –≤ GreenAPI

1. –í–æ–π–¥–∏—Ç–µ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç GreenAPI
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∞—à–µ–≥–æ –∏–Ω—Å—Ç–∞–Ω—Å–∞ –¥–ª—è **5deluxe**
3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ **Webhook URL**:
   ```
   https://your-domain.com/webhook
   ```
4. –í–∫–ª—é—á–∏—Ç–µ —Å–æ–±—ã—Ç–∏—è:
   - ‚úÖ `incomingMessageReceived`

---

## üöÄ –ó–∞–ø—É—Å–∫

### –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞:

```bash
# –ò–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞
python apps/whatsapp_gateway/main.py
```

### Production (Railway):

WhatsApp Gateway –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è —á–µ—Ä–µ–∑ `Procfile`:
```
whatsapp_gateway: python apps/whatsapp_gateway/main.py
```

---

## üìä –õ–æ–≥–∏

–ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞ –≤—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:

```
‚úÖ Loaded WhatsApp config for evopoliki (instance: 7105335266)
‚úÖ Loaded WhatsApp config for five_deluxe (instance: YOUR_INSTANCE_ID)
üì± Total active WhatsApp instances: 2
```

–ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:

```
üè¢ Tenant identified: five_deluxe
üìã [ROUTING] Tenant: five_deluxe -> IVR menu flow
[5DELUXE_IVR] User 996777510804@c.us in state: main_menu, message: '1'
```

---

## üéØ IVR-—Å—Ü–µ–Ω–∞—Ä–∏–π –¥–ª—è 5deluxe

### –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:
```
1 - üíé 5D-–∫–æ–≤—Ä–∏–∫–∏ Deluxe
2 - üëë –ü—Ä–µ–º–∏—É–º-—á–µ—Ö–ª—ã
3 - ‚ú® –ù–∞–∫–∏–¥–∫–∏ –∏–∑ –∞–ª—å–∫–∞–Ω—Ç–∞—Ä—ã
4 - üìû –°–≤—è–∑–∞—Ç—å—Å—è —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º
```

### –°—Ü–µ–Ω–∞—Ä–∏–π –∑–∞–∫–∞–∑–∞:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏—é (—Ü–∏—Ñ—Ä–∞ 1-4)
2. –ë–æ—Ç –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –≤—ã–±—Ä–∞—Ç—å –º–∞—Ä–∫—É –∞–≤—Ç–æ–º–æ–±–∏–ª—è (–ø–∞–≥–∏–Ω–∞—Ü–∏—è: 00/99)
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç –º–æ–¥–µ–ª—å –∞–≤—Ç–æ–º–æ–±–∏–ª—è
4. –ë–æ—Ç –∏—â–µ—Ç –ª–µ–∫–∞–ª–∞ –≤ **–æ–±—â–µ–π –ë–î PostgreSQL**
5. –ï—Å–ª–∏ –ª–µ–∫–∞–ª–∞ –Ω–∞–π–¥–µ–Ω—ã ‚Üí –≤—ã–±–æ—Ä –æ–ø—Ü–∏–π ‚Üí –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞
6. –ë–æ—Ç –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω
7. –ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è (TODO: –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Airtable)

---

## üîç –û—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î:

```bash
python check_db_connection.py five_deluxe
```

–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
```
‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ
   Tenant: five_deluxe
‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö... –£–°–ü–ï–®–ù–û.
‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç: –ù–∞–π–¥–µ–Ω–æ 82 –º–∞—Ä–æ–∫.
```

### Health Check:

```bash
curl http://localhost:8000/
```

–û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç:
```json
{
  "status": "ok",
  "service": "WhatsApp Gateway",
  "version": "1.0.0",
  "active_tenants": 2
}
```

---

## üì¶ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

–í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑:
- `requirements.txt` (–æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–µ–∫—Ç)
- `apps/whatsapp_gateway/requirements.txt` (FastAPI, httpx)

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞

- ‚úÖ –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–µ—Ä–≤–µ—Ä–∞ –≤–∏–¥–Ω—ã 2 –∞–∫—Ç–∏–≤–Ω—ã—Ö tenant (evopoliki + five_deluxe)
- ‚úÖ –ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ –Ω–æ–º–µ—Ä 5deluxe –±–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç IVR-–º–µ–Ω—é
- ‚úÖ –ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ –Ω–æ–º–µ—Ä evopoliki –±–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç —á–µ—Ä–µ–∑ AI
- ‚úÖ IVR-—Å—Ü–µ–Ω–∞—Ä–∏–π –¥–ª—è 5deluxe —É—Å–ø–µ—à–Ω–æ –Ω–∞—Ö–æ–¥–∏—Ç –ª–µ–∫–∞–ª–∞ –≤ –æ–±—â–µ–π –ë–î
- ‚úÖ –ó–∞—è–≤–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º `tenant_id`

---

## üîß –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Airtable

–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–æ–∫ –≤ Airtable, –¥–æ–±–∞–≤—å—Ç–µ –≤ `ivr_handlers_5deluxe.py` —Ñ—É–Ω–∫—Ü–∏—é `handle_phone_input()`:

```python
# TODO: –í—ã–∑–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏
# from packages.core.handlers.requests import create_request
# await create_request(user_data, config)
```

---

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–î–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:
- [GreenAPI Setup](GREENAPI_SETUP.md)
- [Deployment](DEPLOYMENT.md)
